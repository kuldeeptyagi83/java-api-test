# Stage 1: Gradle Build
FROM gradle:7.6-jdk17 AS build

WORKDIR /app

# Copy the Gradle wrapper and the build files
COPY gradlew .
COPY gradle/ gradle/
COPY build.gradle .

# Copy the rest of the application code
COPY src/ src/

# Make the Gradle wrapper executable
RUN chmod +x gradlew

# Build the application
RUN ./gradlew clean test bootJar --no-daemon

# Stage 2: Final image
FROM openjdk:17.0.1-jdk-slim

# Install curl
RUN apt-get update && apt-get install -y curl

EXPOSE 8080

WORKDIR /app

COPY --from=build /app/build/libs/*.jar /app/spring-boot-application.jar
RUN pwd && ls -la

ENTRYPOINT [ "java", "-jar", "spring-boot-application.jar" ]
